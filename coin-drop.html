<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Drop Game</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif;
        }
        
        #gameCanvas {
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            cursor: crosshair;
        }
        
        .mega-counter {
            margin-bottom: 15px;
            padding: 15px 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 24px;
            font-weight: bold;
            color: #FF0000;
        }
        .bank-bonus {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 3px solid #FF8C00;
            border-radius: 8px;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255,140,0,0.5);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .bank-bonus:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(255,140,0,0.7);
        }
        
        .bank-bonus.active {
            background: linear-gradient(135deg, #00FF00, #00CC00);
            border-color: #009900;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .bank-bonus.hidden {
            display: none;
        }
        
        .info {
            margin-top: 20px;
            padding: 15px 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .coin-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .coin-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .coin-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #333;
        }
        .highlight{
            background-color: yellow;
        }
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 20;
            display: none;
        }
        
        .game-over.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .game-over button {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 24px;
            background: #FFD700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .game-over button:hover {
            background: #FFA500;
            transform: scale(1.1);
        }
        #warning{
            background-color: red;
        }
    </style>
</head>
<body>
    <div class="mega-counter">Mega Coins: <span id="megaCount">0</span></div>
    High Score:<span id="max"></span>
    <canvas id="gameCanvas" width="480" height="360"></canvas>
    <div id="bankBonus" class="bank-bonus hidden">üè¶ Bank Bonus<br><small>Click to Remove a Coin</small></div>
    <div id="gameOver" class="game-over">
            <div>GAME OVER!</div>
            <div style="font-size: 24px; margin-top: 10px;">Coins reached the top!</div>
            <button onclick="location.reload()">Play Again</button>
        </div>
    <div>
        <span id="warning"></span>
    </div>
    <div class="info">
        <h3>Click anywhere to drop coins! Match two of the same type to merge them!</h3>
        <div class="coin-legend">
            <div class="coin-item" id="1">
                <div class="coin-color" style="background: #40B0B0;"></div>
                <span>Dime</span>
            </div>
            <div class="coin-item"id="2">
                <div class="coin-color" style="background: #FF0000;"></div>
                <span>Cent</span>
            </div>
            <div class="coin-item" id="3">
                <div class="coin-color" style="background: #C0C0C0;"></div>
                <span>Silver Eagle</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #FFD700;"></div>
                <span>Gold Coin</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #B87333;"></div>
                <span>Standing Liberty</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #B0B0B0;"></div>
                <span>Walking Liberty</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #B0B080;"></div>
                <span>Franklin Half</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #E5E4E2;"></div>
                <span>Platinum Eagle</span>
            </div>
            <div class="coin-item">
                <div class="coin-color" style="background: #FF0000;"></div>
                <span>Mega Coin!</span>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('max').innerText = localStorage.getItem('high score');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const RANKS = {
            0 : 'dime',
            1 : 'cent',
            2 : 'silver eagle',
        };
        const COLORS = {
            'dime': '#40B0B0',
            'cent': '#FF0000',
            'silver eagle': '#C0C0C0',
            'gold coin': '#FFD700',
            'standing Liberty': '#B87333',
            'walking liberty': '#B0B0B0',
            'franklin half': '#B0B080',
            'platinum eagle': '#E5E4E2',
            'mega coin': '#FF0000'
        };
        
        const SIZES = {
            'dime': 15,
            'cent': 20,
            'silver eagle': 30,
            'gold coin': 40,
            'standing Liberty': 50,
            'walking liberty': 60,
            'franklin half': 65,
            'platinum eagle': 70,
            'mega coin': 150
        };
        
        const FUSION_RULES = {
            'dime+dime': 'cent',
            'cent+cent': 'silver eagle',
            'silver eagle+silver eagle': 'gold coin',
            'gold coin+gold coin': 'standing Liberty',
            'standing Liberty+standing Liberty': 'walking liberty',
            'walking liberty+walking liberty': 'franklin half',
            'franklin half+franklin half': 'platinum eagle'
        };
        
        class Coin {
            constructor(type, x, y, id) {
                this.type = type;
                this.x = x;
                this.y = y;
                this.id = id;
                this.xChange = 0;
                this.yChange = 0;
                this.radius = SIZES[type];
                this.toRemove = false;
            }
            
            update() {
                // Apply gravity
                this.yChange -= 0.5;
                
                // Update position
                this.x += this.xChange;
                this.y += this.yChange;
                
                // Bounce off edges
                if (this.x < -240 + this.radius) {
                    this.x = -240 + this.radius;
                    this.xChange = Math.abs(this.xChange) * 0.8;
                } else if (this.x > 240 - this.radius) {
                    this.x = 240 - this.radius;
                    this.xChange = -Math.abs(this.xChange) * 0.8;
                }
                
                if (this.y < -180 + this.radius) {
                    this.y = -180 + this.radius;
                    this.yChange = Math.abs(this.yChange) * 0.8;
                }
                
                // Apply stronger damping to reduce vibration
                this.xChange *= 0.95;
                this.yChange *= 0.95;
                
                // Stop very small movements to prevent endless vibration
                if (Math.abs(this.xChange) < 0.05) this.xChange = 0;
                if (Math.abs(this.yChange) < 0.05) this.yChange = 0;
            }
            
            draw() {
                const px = this.x + 240;
                const py = 180 - this.y;
                
                ctx.beginPath();
                ctx.arc(px, py, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = COLORS[this.type];
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Add shine effect for mega coin
                if (this.type === 'mega coin') {
                    ctx.beginPath();
                    ctx.arc(px - this.radius/3, py - this.radius/3, this.radius/3, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fill();
                }
            }
        }
        
        class CoinSimulator {
            constructor() {
                this.coins = [];
                this.nextId = 1;
                this.megaCoinsCount = 0;
                this.nextCoin = "dime";
                this.gameOver = false;
                this.topWarningTimer = null;
                this.setupEventListeners();
                this.animate();
            }
            
            setupEventListeners() {
                canvas.addEventListener('click', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 240;
                    const y = 150;
                    // If bank bonus is active, try to remove a coin
                    if (this.bankBonusActive) {
                        this.removeCoinAtPosition(x, y);
                    } else {
                        // Normal coin drop
                        this.coins.push(new Coin(this.nextCoin, x, y, this.nextId++));
                        this.nextCoin = RANKS[Math.floor(Math.random() * 3)];
                    }
                });
                
                // Bank bonus button click handler
                document.getElementById('bankBonus').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click from reaching canvas
                    if (this.bankBonusAvailable) {
                        this.bankBonusActive = !this.bankBonusActive;
                        const bonusBtn = document.getElementById('bankBonus');
                        if (this.bankBonusActive) {
                            bonusBtn.classList.add('active');
                            canvas.style.cursor = 'pointer';
                        } else {
                            bonusBtn.classList.remove('active');
                            canvas.style.cursor = 'crosshair';
                        }
                    }
                });
            }
            
            removeCoinAtPosition(clickX, clickY) {
                console.log('Click position (canvas pixels):', clickX, clickY);
                console.log('Total coins:', this.coins.length);
                
                // Find the coin closest to the click position
                let closestCoin = null;
                let closestDistance = Infinity;
                
                for (const coin of this.coins) {
                    // Convert coin position to canvas pixels (same as in draw method)
                    const coinPx = coin.x + 240;
                    const coinPy = 180 - coin.y;
                    
                    const dx = coinPx - clickX;
                    const dy = coinPy - clickY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    console.log(`Coin game coords: (${coin.x.toFixed(2)}, ${coin.y.toFixed(2)}), canvas pixels: (${coinPx.toFixed(2)}, ${coinPy.toFixed(2)}), distance: ${distance.toFixed(2)}, radius: ${coin.radius}`);
                    
                    // Find the absolute closest coin
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestCoin = coin;
                    }
                }
                
                console.log('Closest coin distance:', closestDistance.toFixed(2));
                
                // Remove the closest coin (no distance requirement)
                if (closestCoin) {
                    const index = this.coins.indexOf(closestCoin);
                    if (index > -1) {
                        this.coins.splice(index, 1);
                        console.log('Coin removed!');
                        // Deactivate and hide bank bonus after use
                        this.bankBonusActive = false;
                        this.bankBonusAvailable = false;
                        document.getElementById('bankBonus').classList.add('hidden');
                        document.getElementById('bankBonus').classList.remove('active');
                        canvas.style.cursor = 'crosshair';
                    }
                }
            }
            
            
            showBankBonus() {
                this.bankBonusAvailable = true;
                const bonusBtn = document.getElementById('bankBonus');
                bonusBtn.classList.remove('hidden');
            }
            checkGameOver() {
                // Check if any coin is at the top of the screen
                const topThreshold = 150; // Game coordinate (top area)
                let coinAtTop = false;
                
                for (const coin of this.coins) {
                    if (coin.y >= topThreshold) {
                        coinAtTop = true;
                        break;
                    }
                }
                
                if (coinAtTop && !this.topWarningTimer && !this.gameOver) {
                    // Start a 1-second timer
                    document.getElementById('warning').innerHTML = "uh-oh!"
                setTimeout(() => {
                    document.getElementById('warning').innerHTML = ""
                }, 1000);
                    this.topWarningTimer = setTimeout(() => {
                        // Check again if coin is still at top
                        let stillAtTop = false;
                        for (const coin of this.coins) {
                            if (coin.y >= topThreshold) {
                                stillAtTop = true;
                                break;
                            }
                        }
                        
                        if (stillAtTop) {
                            this.triggerGameOver();
                        }
                        this.topWarningTimer = null;
                    }, 1000);
                } else if (!coinAtTop && this.topWarningTimer) {
                    // Cancel timer if no coins at top anymore
                    clearTimeout(this.topWarningTimer);
                    this.topWarningTimer = null;
                }
            }
            
            triggerGameOver() {
                this.gameOver = true;
                document.getElementById('gameOver').classList.add('show');
                canvas.style.cursor = 'default';
                if (localStorage.getItem('high score') != null){
                    if (parseInt(localStorage.getItem('high score') < this.megaCoinsCount)){
                        localStorage.setItem('high score',this.megaCoinsCount )
                    }
                }
            }
            
            checkCollisions() {
                const coinsToRemove = new Set();
                const coinsToAdd = [];
                
                for (let i = 0; i < this.coins.length; i++) {
                    if (coinsToRemove.has(this.coins[i])) continue;
                    
                    for (let j = i + 1; j < this.coins.length; j++) {
                        if (coinsToRemove.has(this.coins[j])) continue;
                        
                        const coin = this.coins[i];
                        const other = this.coins[j];
                        
                        const dx = coin.x - other.x;
                        const dy = coin.y - other.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const minDistance = coin.radius + other.radius;
                        
                        if (distance < minDistance) {
                            const fusionKey = `${coin.type}+${other.type}`;
                            const fusionKeyReverse = `${other.type}+${coin.type}`;
                            
                            if (FUSION_RULES[fusionKey] || FUSION_RULES[fusionKeyReverse]) {
                                const newType = FUSION_RULES[fusionKey] || FUSION_RULES[fusionKeyReverse];
                                
                                const newX = (coin.x + other.x) / 2;
                                const newY = (coin.y + other.y) / 2;
                                
                                const newCoin = new Coin(newType, newX, newY, this.nextId++);
                                newCoin.xChange = (coin.xChange + other.xChange) / 2;
                                newCoin.yChange = (coin.yChange + other.yChange) / 2;
                                
                                coinsToRemove.add(coin);
                                coinsToRemove.add(other);
                                coinsToAdd.push(newCoin);
                                break;
                            } else {
                                // Normal collision
                                const angle = Math.atan2(dy, dx);
                                const overlap = minDistance - distance;
                                
                                if (distance > 0) {
                                    coin.x += (dx / distance) * overlap * 0.5;
                                    coin.y += (dy / distance) * overlap * 0.5;
                                    other.x -= (dx / distance) * overlap * 0.5;
                                    other.y -= (dy / distance) * overlap * 0.5;
                                }
                                
                                coin.xChange += Math.cos(angle) * 1.5;
                                coin.yChange += Math.sin(angle) * 1.5;
                                other.xChange -= Math.cos(angle) * 1.5;
                                other.yChange -= Math.sin(angle) * 1.5;
                            }
                        }
                    }
                }
                
                // Check for mega coin creation
                const platinumCoins = this.coins.filter(c => c.type === 'platinum eagle' && !coinsToRemove.has(c));
                if (platinumCoins.length >= 2) {
                    const coin1 = platinumCoins[0];
                    const coin2 = platinumCoins[1];
                    
                    const newX = (coin1.x + coin2.x) / 2;
                    const newY = (coin1.y + coin2.y) / 2;
                    const megaCoin = new Coin('mega coin', newX, newY, this.nextId++);
                    megaCoin.xChange = (coin1.xChange + coin2.xChange) / 2;
                    megaCoin.yChange = (coin1.yChange + coin2.yChange) / 2;
                    
                    coinsToRemove.add(coin1);
                    coinsToRemove.add(coin2);
                    coinsToAdd.push(megaCoin);
                    
                    // Increment mega coin counter
                    this.megaCoinsCount++;
                    document.getElementById('megaCount').textContent = this.megaCoinsCount;
                    
                    // Show bank bonus
                    this.showBankBonus();
                    
                    setTimeout(() => {
                        const index = this.coins.indexOf(megaCoin);
                        if (index > -1) {
                            this.coins.splice(index, 1);
                        }
                    }, 2000);
                }
                
                this.coins = this.coins.filter(c => !coinsToRemove.has(c));
                this.coins.push(...coinsToAdd);
            }
            warning(){
                document.getElementById('warning').innerHTML = "uh-oh!"
                setTimeout(() => {
                    document.getElementById('warning').innerHTML = ""
                }, 1000);
            }
            animate() {
                // Update all coins
                this.coins.forEach(coin => coin.update());
                
                // Check collisions
                this.checkCollisions();
                
                // Clear canvas
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw all coins
                this.coins.forEach(coin => coin.draw());
                
                requestAnimationFrame(() => this.animate());
            }
            updateDisplay(){
                document.getElementById('3').classList.remove('highlight');
                document.getElementById('2').classList.remove('highlight');
                document.getElementById('1').classList.remove('highlight');
            if (this.nextCoin == 'dime') {
                document.getElementById('1').classList.add('highlight');
            }
            if(this.nextCoin == 'cent') {
                document.getElementById('2').classList.add('highlight');
            }
            if(this.nextCoin == 'silver eagle') {
                document.getElementById('3').classList.add('highlight');
            }

        };
    }
        // Start the game
        let game = new CoinSimulator();
        setInterval(function(){game.updateDisplay()},1); 
        setInterval(function(){game.checkGameOver()},10); 
    </script>
</body>
</html>
